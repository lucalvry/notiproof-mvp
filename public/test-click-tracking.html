<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotiProof Click Tracking Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .console-log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .test-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-pass {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .test-fail {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }
    </style>
</head>
<body>
    <h1>NotiProof Click Tracking Test Page</h1>
    
    <div class="test-section">
        <h2>Test Instructions</h2>
        <ol>
            <li>Open browser developer tools (F12) and go to Network tab</li>
            <li>Click the widget notification when it appears</li>
            <li>Look for POST requests to the widget API</li>
            <li>Check the console logs below for tracking confirmations</li>
            <li>Test rapid clicking to verify deduplication works</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Console Logs</h2>
        <div id="console-output" class="console-log">Waiting for widget to load...</div>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="test-section">
        <h2>Manual Test Controls</h2>
        <button onclick="manualClick()">Simulate Manual Click</button>
        <button onclick="rapidClicks()">Test Rapid Clicks (5x)</button>
        <button onclick="testConversion()">Test Conversion Event</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <div class="test-section">
        <h2>Page Content</h2>
        <p>This is a test page to verify that NotiProof widgets properly track click events. The widget should appear after a few seconds, and clicking it should send tracking data to the backend.</p>
        
        <p>Key features being tested:</p>
        <ul>
            <li>Click event tracking with sendBeacon/fetch keepalive</li>
            <li>Session-based deduplication (1 second window)</li>
            <li>Metadata collection (page URL, referrer, user agent)</li>
            <li>Rate limiting on backend (2 second window per session)</li>
            <li>Real-time dashboard updates</li>
        </ul>
    </div>

    <!-- NotiProof Widget Script -->
    <script 
        src="widget.js" 
        data-widget-id="c26c2241-7b80-4ee7-ba31-55ae342db25c"
        data-api-base="https://ewymvxhpkswhsirdrjub.supabase.co/functions/v1/widget-api">
    </script>

    <script>
        let testResults = [];
        
        // Console logging capture
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function addToConsole(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const output = document.getElementById('console-output');
            output.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addToConsole('warn', args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsole('error', args.join(' '));
        };
        
        function clearConsole() {
            document.getElementById('console-output').textContent = 'Console cleared...\n';
        }
        
        function addTestResult(name, passed, details) {
            testResults.push({ name, passed, details, timestamp: new Date() });
            updateTestResults();
        }
        
        function updateTestResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(result => `
                <div class="test-status ${result.passed ? 'test-pass' : 'test-fail'}">
                    <strong>${result.name}:</strong> ${result.passed ? 'PASS' : 'FAIL'}
                    <br><small>${result.details}</small>
                    <br><small>Time: ${result.timestamp.toLocaleTimeString()}</small>
                </div>
            `).join('');
        }
        
        function manualClick() {
            if (window.NotiProof) {
                console.log('Manual click triggered');
                // Find widget and trigger click
                const widget = document.querySelector('.notiproof-widget');
                if (widget) {
                    widget.click();
                    addTestResult('Manual Click', true, 'Successfully triggered click on widget');
                } else {
                    addTestResult('Manual Click', false, 'No widget found on page');
                }
            } else {
                addTestResult('Manual Click', false, 'NotiProof API not available');
            }
        }
        
        function rapidClicks() {
            console.log('Testing rapid clicks...');
            let clickCount = 0;
            const interval = setInterval(() => {
                manualClick();
                clickCount++;
                if (clickCount >= 5) {
                    clearInterval(interval);
                    addTestResult('Rapid Clicks', true, 'Completed 5 rapid clicks - check for deduplication');
                }
            }, 200); // 200ms between clicks
        }
        
        function testConversion() {
            if (window.NotiProof) {
                window.NotiProof.trackConversion({
                    type: 'test_conversion',
                    value: 29.99,
                    currency: 'USD'
                });
                addTestResult('Conversion Tracking', true, 'Sent test conversion event');
                console.log('Test conversion event sent');
            } else {
                addTestResult('Conversion Tracking', false, 'NotiProof API not available');
            }
        }
        
        // Monitor network requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            if (typeof url === 'string' && url.includes('widget-api')) {
                console.log('API Request:', args[0], args[1]?.method || 'GET');
                if (args[1]?.body) {
                    try {
                        const body = JSON.parse(args[1].body);
                        console.log('Request Body:', body);
                        if (body.event_type === 'click') {
                            addTestResult('Click Event Sent', true, `Click tracked with session: ${body.metadata?.session_id}`);
                        }
                    } catch (e) {
                        console.log('Request Body (non-JSON):', args[1].body);
                    }
                }
            }
            return originalFetch.apply(this, args);
        };
        
        // Monitor sendBeacon
        const originalSendBeacon = navigator.sendBeacon;
        navigator.sendBeacon = function(url, data) {
            console.log('SendBeacon called:', url);
            if (url.includes('widget-api')) {
                try {
                    if (data instanceof Blob) {
                        data.text().then(text => {
                            const parsed = JSON.parse(text);
                            console.log('SendBeacon data:', parsed);
                            if (parsed.event_type === 'click') {
                                addTestResult('SendBeacon Click', true, `Used sendBeacon for click tracking`);
                            }
                        });
                    }
                } catch (e) {
                    console.log('SendBeacon data (raw):', data);
                }
            }
            return originalSendBeacon.call(this, url, data);
        };
        
        // Initial setup
        window.addEventListener('load', () => {
            console.log('Test page loaded, waiting for widget...');
            addTestResult('Page Load', true, 'Test page initialized successfully');
        });
        
        // Check for widget after delay
        setTimeout(() => {
            const widget = document.querySelector('.notiproof-widget');
            if (widget) {
                addTestResult('Widget Load', true, 'Widget found on page');
                console.log('Widget detected on page');
            } else {
                addTestResult('Widget Load', false, 'Widget not found after 10 seconds');
            }
        }, 10000);
    </script>
</body>
</html>